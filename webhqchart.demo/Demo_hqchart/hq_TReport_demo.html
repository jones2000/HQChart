<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">  
<head>  
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />  
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<title>T型报价</title>  
    <link rel="stylesheet" href="../jscommon/umychart.resource/css/tools.css" />
    <link rel="stylesheet" href="../jscommon/umychart.resource/font/iconfont.css" />
</head>  
<body>
    <div id="FullDemo">
        <div id="TopPanel">
            <div id="Report"> 
                <div id="ReportCtrl"></div>
            </div>
            <div id="Minute">
                <div id="MinuteCtrl"></div>
            </div>
        </div>

        <div id="PeriodList">
            <div class="PeriodItem" >期权: </div>
            <div class="PeriodItem" id="PItem1">2025</div>
            <div class="PeriodItem" id="PItem2">2025</div>
            <div class="PeriodItem" id="PItem3">2025</div>
            <div class="PeriodItem" id="PItem4">2025</div>
            <div class="PeriodItem" id="PItem5">2025</div>
            <div class="PeriodItem" id="PItem6">2025</div>
            <div class="PeriodItem" id="PItem7">2025</div>
            <div class="PeriodItem" id="PItem8">2025</div>
            <div class="PeriodItem" id="PItem9">2025</div>
            <div class="PeriodItem" id="PItem10">2025</div>
            <div class="PeriodItem" id="PItem11">2025</div>
            <div class="PeriodItem" id="PItem12">2025</div>
        </div>
        <div id="TReport"> 
            <div id="TReportCtrl">
            </div>
        </div>
    </div>

    <div id="BottomStatusBar">
        <div id="StatuBarCtrl"></div>
    </div>

    <!-- 弹框遮罩层 -->
    <div class="modal-mask" id="settingModal">
        <!-- 弹框内容 -->
        <div class="modal-content">
            <div class="modal-title">系统设置</div>
            <form id="settingForm">
                <div class="form-item">
                    <label for="extendID">HQChartData数据插件ID</label>
                    <input type="text" id="extendID" name="extendID" placeholder="请输入插件ID">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-cancel" id="cancelBtn">取消</button>
                    <button type="button" class="btn btn-save" id="saveBtn">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../jscommon/umychart.resource/js/jquery.min.js"></script>
    <script src="../jscommon/umychart.resource/js/webfont.js"></script>
    <script src='../jscommon/umychart.console.js'></script>     <!-- 日志输出 -->
    <script src="../jscommon/umychart.network.js"></script>
    <script src="../jscommon/umychart.js"></script>             <!-- K线图形 -->
    <script src="../jscommon/umychart.complier.js"></script>    <!-- 麦语言解析执行器 -->
    <script src="../jscommon/umychart.index.data.js"></script>  <!-- 基础指标库 -->
    <script src="../jscommon/umychart.report.js"></script>    <!-- 报价列表 -->
    <script src="../jscommon/umychart.TReport.js"></script>    <!-- T型报价 -->
    <script src="../jscommon/umychart.style.js"></script>       <!-- 白色风格和黑色风格配置信息 -->
    <script src="../jscommon/umychart.popMenu.js"></script>
    <script src="../jscommon/umychart.PopKLineChart.js"></script>
    <script src="../jscommon/umychart.PopMinuteChart.js"></script>
    <script src="../jscommon/umychart.DialogTooltip.js"></script>
    <script src="../jscommon/umychart.DialogSelectRect.js"></script>
    <script src="../jscommon/umychart.DialogSearchIndex.js"></script>
    <script src="../jscommon/umychart.DialogDrawTool.js"></script>
    <script src="../jscommon/umychart.StatusBar.js"></script>
    <script src="../jscommon/umychart.version.js"></script>

    <script src="./src/MinuteChart.js"></script>
    <script src="./src/TReportChart.js"></script>
    <script src="./src/MessageData.js"></script>
    <script src="./src/FullReportChart.js"></script>
    <script src="./src/EnvironmentVariable.js"></script>
    <script src="./src/StatusBarChart.js"></script>
    <script src="./src/HQData.js"></script>  <!-- 数据 -->

    <script>

        //JSConsole.Chart.Log=() =>{}
        //JSConsole.Complier.Log=()=>{}

        MARKET_SUFFIX_NAME.GetMarketStatus = function (symbol)  { return 2; }

        class ChartContainer
        {
            FullReportCtrl=new FullReportChart();
            MinuteCtrl=new MinuteChart();
            TReportCtrl=new TReportChart();
            StatusBarCtrl=new StatusBarChart();

            PeriodCtrl=
            {
                AryPeriod:[],
                Selected:null,
            }

            Create()
            {
                HQChartWSClient.NetworkStatusCallback=(data)=>{ this.UpdateNetworkStatus(data); }
                var resource=JSChart.GetResource();
                resource.ToolbarButtonStyle=1;
                resource.FrameLogo.Text+= ` ${HQCHART_VERSION}`;

                this.ChangeStyle(STYLE_TYPE_ID.BLACK_ID);

                this.BindPeriodDOM();

                this.FullReportCtrl.OnCreate=()=>{ this.OnCreateReport(this.FullReportCtrl); }
                this.FullReportCtrl.Create(document.getElementById('ReportCtrl'));
                this.FullReportCtrl.OnClickRowCallback=(data, obj, reportCtrl)=>{ this.OnClickReportRow(data, obj, reportCtrl); }

                this.MinuteCtrl.OnCreate=()=>{ this.OnCreateMinute(this.MinuteCtrl); }
                this.MinuteCtrl.Create(document.getElementById('MinuteCtrl'));

                this.StatusBarCtrl.Create(document.getElementById('StatuBarCtrl'));
                //this.StatusBarCtrl.OnClickStockCallback=(data, obj)=>{ this.ChangeSymbol(data.Symbol); }
                this.StatusBarCtrl.OnClickRightToolbarCallback=(data, obj)=>{ this.OnClickBottomToolbar(data, obj); }

                //this.TReportCtrl.Symbol="159922-2602.szo";
                this.TReportCtrl.Symbol="510300.sh";
                this.TReportCtrl.Create(document.getElementById('TReportCtrl'));
                this.TReportCtrl.OnClickRowCallback=(data, obj, reportCtrl)=>{ this.OnClickTReportRow(data, obj, reportCtrl); }
                this.TReportCtrl.OnRecvStockListCallback=(obj)=>{ this.UpdatePeriodButton(obj); }
                
                //this.TReportCtrl.Symbol=


                this.FullReportCtrl.ChangeSymbol(HQ_CLASS_SYMBOL.SHSZ_OPTION_ETF.Symbol);
                this.MinuteCtrl.ChangeSymbol("510050.sh");

                addEventListener("resize", (event) => { this.OnSize(event); });
                this.OnSize();
            }

            BindPeriodDOM()
            {
                const ARRAY_ID=["PItem1", "PItem2","PItem3","PItem4","PItem5","PItem6","PItem7","PItem8","PItem9","PItem10","PItem11","PItem12",];
                for(var i=0;i<ARRAY_ID.length;++i)
                {
                    var div=document.getElementById(ARRAY_ID[i]);
                    this.PeriodCtrl.AryPeriod.push({ DOM:div, IsSho:false, Title:null });
                    div.style["display"]="none";
                    this.BindPeriodClick(div, i);
                }
            }

            BindPeriodClick(dom, index)
            {
                dom.onmousedown=(e)=>
                { 
                    this.OnClickPeriodButton(e, index);
                }
            }

            OnCreateReport(reportCtrl)
            {
                reportCtrl.Option.Tab=
                [
                    { Title:HQ_CLASS_SYMBOL.SHSZ_OPTION_ETF.Name, ID:HQ_CLASS_SYMBOL.SHSZ_OPTION_ETF.Symbol , CommandID:JSCHART_MENU_ID.CMD_REPORT_CHANGE_BLOCK_ID},
                    { Title:HQ_CLASS_SYMBOL.CFFEX_OPTION_INDEX.Name, ID:HQ_CLASS_SYMBOL.CFFEX_OPTION_INDEX.Symbol , CommandID:JSCHART_MENU_ID.CMD_REPORT_CHANGE_BLOCK_ID},

                    { Title:HQ_CLASS_SYMBOL.SHFE_OPTION_FUTRUES.Name, ID:HQ_CLASS_SYMBOL.SHFE_OPTION_FUTRUES.Symbol , CommandID:JSCHART_MENU_ID.CMD_REPORT_CHANGE_BLOCK_ID},
                    { Title:HQ_CLASS_SYMBOL.DCE_OPTION_FUTRUES.Name, ID:HQ_CLASS_SYMBOL.DCE_OPTION_FUTRUES.Symbol , CommandID:JSCHART_MENU_ID.CMD_REPORT_CHANGE_BLOCK_ID},
                    { Title:HQ_CLASS_SYMBOL.CZCE_OPTION_FUTRUES.Name, ID:HQ_CLASS_SYMBOL.CZCE_OPTION_FUTRUES.Symbol , CommandID:JSCHART_MENU_ID.CMD_REPORT_CHANGE_BLOCK_ID},
                    { Title:HQ_CLASS_SYMBOL.GZFE_OPTION_FUTRUES.Name, ID:HQ_CLASS_SYMBOL.GZFE_OPTION_FUTRUES.Symbol , CommandID:JSCHART_MENU_ID.CMD_REPORT_CHANGE_BLOCK_ID},
                    { Title:HQ_CLASS_SYMBOL.INE_OPTION_FUTRUES.Name, ID:HQ_CLASS_SYMBOL.INE_OPTION_FUTRUES.Symbol , CommandID:JSCHART_MENU_ID.CMD_REPORT_CHANGE_BLOCK_ID},
                    
                ];

                reportCtrl.Option.Symbol=HQ_CLASS_SYMBOL.SHSZ_OPTION_ETF.Symbol;
                reportCtrl.Option.Name=HQ_CLASS_SYMBOL.SHSZ_OPTION_ETF.Name;
                reportCtrl.Option.Border.Right=1;
                reportCtrl.Option.Border.Bottom=1;
            }

            OnCreateMinute(minuteCtrl)
            {
                minuteCtrl.Option.Windows=[];
            }

            OnClickReportRow(data, obj, reportCtrl)
            {
                var symbol=data.Data.Symbol;
                console.log(`[ChartContainer::OnClickReportRow] symbol=${symbol}`);
                this.MinuteCtrl.ChangeSymbol(symbol);
                var period=2601;

                this.ResetPeriodButton();
                this.TReportCtrl.ChangeSymbol(symbol);

                var msgData={ ID:PAGE_MESSAGE_ID.CLICK_REPORT_ROW_ID, Symbol:symbol, From:reportCtrl.Name };
                localStorage.setItem(PAGE_MESSAGE_KEY, JSON.stringify(msgData))
            }

            OnClickTReportRow(data, obj, reportCtrl)
            {
                console.log('[ChartContainer::OnClickTReportRow] data=', data);

                var item=null;
                if (data.Data.CellType===1)
                {
                    if (data.Data.Item && data.Data.Item.LeftData) item=data.Data.Item.LeftData;
                }
                else if (data.Data.CellType==2)
                {
                    if (data.Data.Item && data.Data.Item.RightData) item=data.Data.Item.RightData;
                }

                if (item && item.Symbol)
                {
                    var msgData={ ID:PAGE_MESSAGE_ID.CLICK_TREPORT_ROW_ID, Symbol:item.Symbol, From:reportCtrl.Name };
                    localStorage.setItem(PAGE_MESSAGE_KEY, JSON.stringify(msgData));
                }
                
            }

            //整体布局
            OnSize(event)
            {
                var height= $(window).height();
                var width = $(window).width();

                var statusBarHeight=this.GetStatusBarHeight();

                var statusBar=document.getElementById('BottomStatusBar');
                statusBar.style.height=`${statusBarHeight}px`;

                var minMniuteWidth=500;
                var value=width*0.3;
                if (value<minMniuteWidth) value=minMniuteWidth;
                var report=document.getElementById('Report');
                report.style.width=`${width-value}px`;
                var minute=document.getElementById('Minute');
                minute.style.width=`${value}px`;

                var fullDemo=document.getElementById('FullDemo');
                fullDemo.style.height=`${height-statusBarHeight-2}px`;

                var periodHeight=$("#PeriodList")[0].offsetHeight;
                var reportHeight=$("#TopPanel")[0].offsetHeight;
                var tReportHeight=$('#FullDemo')[0].offsetHeight-periodHeight-reportHeight;
                
                var tReport=document.getElementById('TReport');
                tReport.style.height=`${tReportHeight}px`;
            }

            GetStatusBarHeight()
            {
                var pixelRatio=GetDevicePixelRatio();
                var statusBarHeigth=(14*pixelRatio+(5+5)*pixelRatio)/pixelRatio;

                return statusBarHeigth;
            }

            ChangeStyle(value)
            {
                var style=HQChartStyle.GetStyleConfig(value); //读取风格配置
                JSChart.SetCSSStyle(value);
                JSChart.SetStyle(style);

                if (this.FullReportCtrl) this.FullReportCtrl.ReloadResource();  //动态更新颜色配置  
                if (this.StatusBarCtrl) this.StatusBarCtrl.ReloadResource();
            }

            UpdateNetworkStatus(data)
            {
                if (this.StatusBarCtrl)  this.StatusBarCtrl.UpdateNetworkStatus(data);
            }

            UpdatePeriodButton(obj)
            {
                var periodData=obj.PeriodData;
                if (IFrameSplitOperator.IsNonEmptyArray(periodData.AryData))
                {
                    for(var i=0;i<periodData.AryData.length;++i)
                    {
                        var item=periodData.AryData[i];
                        var pItem=this.PeriodCtrl.AryPeriod[i];
                        pItem.Title=item.Period;
                        pItem.IsShow=true;
                        pItem.Data=item;
                        pItem.DOM.innerText=pItem.Title;
                        pItem.DOM.style["display"]="block";
                    }
                }
            }

            ResetPeriodButton()
            {
                for(var i=0;i<this.PeriodCtrl.AryPeriod.length;++i)
                {
                    var item=this.PeriodCtrl.AryPeriod[i];
                    if (!item) continue;
                    item.Data=null;
                    if (item.DOM) item.DOM.style["display"]="none";
                }
            }

            OnClickPeriodButton(e, index)
            {
                var pItem=this.PeriodCtrl.AryPeriod[index];
                if (!pItem || !pItem.Data) return;
                
                this.TReportCtrl.ChangePeriod(pItem.Data.Period, pItem.Data.UnderlyingSymbol);

            }

            OnClickBottomToolbar(data, obj)
            {
                if (data.ID==2) //设置
                {
                    this.OnSettings();
                }
                else if (data.ID==1)    //网络
                {

                }
                else if (data.ID==3)    //搜索
                {
                    //this.KeyboardCtrl.Show();
                }
            }

            //设置
            OnSettings()
            {
                const modalMask = document.getElementById('settingModal');
                const cancelBtn = document.getElementById('cancelBtn');
                const settingForm = document.getElementById('settingForm');
                const input = document.getElementById('extendID');
                if (!modalMask) return;

                input.value = EnvironmentVariable.TargetExtensionID;

                cancelBtn.onclick=(e)=>
                {
                    modalMask.style.display = 'none';
                };

                saveBtn.onclick=(e)=>
                {
                    const input = document.getElementById('extendID');
                    var value=input.value.trim();
                    EnvironmentVariable.TargetExtensionID=value;
                    EnvironmentVariable.Save();

                    modalMask.style.display = 'none';

                    setTimeout(() => { location.reload(); }, 1000);
                }

                modalMask.style.display = 'flex';
                
            }
        }

        $(function () 
        {
            WebFont.load({ custom: { families: ['iconfont'] } });   //预加载下iconfont资源
 
            EnvironmentVariable.Load();

            var chartContainer=new ChartContainer();
            chartContainer.Create();
            
        })

    </script>  
</body>  
</html>


<style>

html,body
{
    height:100%;
    overflow-x:hidden;
}

body 
{
    margin:0px;
    font-size:14px;
    background-color: var(--BGColor);
}

#FullDemo
{
    
    height:800px
}

#TopPanel
{
    display:flex;
    width: 100%;
    height:30%;
}

#Report
{
    width:80%;
    height:100%;
    position: relative;
    /*margin-top: 100px;*/
}

#ReportCtrl
{
    width: 100%;
    height:100%;
    position: relative;
}

#Minute
{
    width: 20%;
    height: 100%;
}

#MinuteCtrl
{
    width: 100%;
    height: 100%;
    position: relative;
}

#PeriodList
{
    width: 100%;
    display: flex;
    background-color: var(--BGColor);
    line-height: 25px;
    border-top:solid 1px var(--BorderColor);
}

.PeriodItem
{
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;

    padding-left: 5px;
    padding-right: 5px;
    border-right:solid 1px var(--BorderColor);
    cursor: default;
    background-color: var(--TabItemBG);
    color:var(--TabTextColor);

    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

#TReport
{
    width: 100%;
    height:500px;
    position: relative;
}


#TReportCtrl
{
    width: 100%;
    height:100%;
    position: relative;
}

#BottomStatusBar
{
    width: 100%;
    height: 30px;
}

#StatuBarCtrl
{
    width: 100%;
    height: 100%;
    border-bottom:solid 1px var(--BorderColor);
}


/*
    白色风格
*/
:root[hqchart_style='0'],
:root[hqchart_style='defined']
{
    --BGColor:rgb(255,255,255);
    --TabItemBG:rgb(242,242,242);
    --BorderColor:rgb(206,206,206);
    --TabTextColor:rgb(90,90,90);
}

/*
    黑色风格
*/
:root[hqchart_style='1']
{
    --BGColor:rgb(0,0,0);
    --TabItemBG:rgb(38,38,38);
    --BorderColor:rgb(74,74,74);
    --TabTextColor:rgb(204,204,204);
}
    


/*
设置弹框 AI生成
*/

/* 弹框遮罩层 */
.modal-mask 
{
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    /* 默认隐藏 */
    display: none;
}

/* 弹框主体 */
.modal-content {
    width: 400px;
    padding: 20px;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
}

/* 弹框标题 */
.modal-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

/* 表单项样式 */
.form-item {
    margin-bottom: 20px;
}

.form-item label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    color: #333;
}

.form-item input {
    width: 90%;
    padding: 10px;
    font-size: 14px;
    border: 1px solid #dcdfe6;
    border-radius: 4px;
    outline: none;
    transition: border-color 0.3s;
}

.form-item input:focus {
    border-color: #409eff;
}

/* 按钮组样式 */
.btn-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.btn {
    padding: 8px 16px;
    font-size: 14px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.btn-cancel {
    color: #666;
    background-color: #f5f5f5;
}

.btn-cancel:hover {
    background-color: #e5e5e5;
}

.btn-save {
    color: #fff;
    background-color: #409eff;
}

.btn-save:hover {
    background-color: #66b1ff;
}
      
</style>
